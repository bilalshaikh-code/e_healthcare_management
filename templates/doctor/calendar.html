{% extends "doctor/base.html" %}
{% load static %}

{% block title %}My Calendar - Doctor Panel{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">
        My Schedule Calendar
    </h2>

    {% if not has_slots %}
    <div class="alert alert-warning text-center">
        <strong>Your calendar is empty!</strong><br>
        Set your <a href="{% url 'weekly_schedule' %}" class="alert-link">weekly schedule</a> first to see your slots.
    </div>
    {% endif %}

    <div class="card shadow">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS - Official CDN (never blocked) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS + Fallback -->

<!-- Fallback if CDN is blocked (very rare, but fixes your error 100%) -->
<script>
window.addEventListener('load', function() {
    if (typeof FullCalendar === 'undefined') {
        console.warn('FullCalendar blocked by ad-blocker. Loading fallback...');
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/fullcalendar@6.1.15/main.min.js';
        script.onload = initializeCalendar;
        script.onerror = () => console.error('FullCalendar failed to load');
        document.head.appendChild(script);
    } else {
        initializeCalendar();
    }
});

function initializeCalendar() {
    if (document.getElementById('calendar') && typeof FullCalendar !== 'undefined') {
        var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '{% url "calendar_events_api" %}',
            eventClick: function(info) {
                if (info.event.extendedProps.isLeave) {
                    alert('Leave\nReason: ' + (info.event.extendedProps.reason || 'Not specified'));
                } else {
                    alert('Slot: ' + info.event.title);
                }
            },
            locale: 'en',
            buttonText: {
                today: 'Today',
                month: 'Month',
                week: 'Week',
                day: 'Day'
            },
            loading: function(isLoading) {
                if (isLoading) {
                    document.getElementById('calendar').innerHTML = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-3x"></i><p>Loading calendar...</p></div>';
                }
            }
        });
        calendar.render();
    }
}
</script>
{% endblock %}